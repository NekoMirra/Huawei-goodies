name: build-and-package

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: windows-latest
    env:
      DIST_DIR: dist
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Locate Visual Studio (for vcvarsall & nmake)
        id: vswhere
        shell: pwsh
        run: |
          $vs = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
          if (-not $vs) { throw 'Visual Studio not found' }
          "VSPATH=$vs" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "VS path: $vs"

      - name: Ensure dist folders
        shell: pwsh
        run: |
          $d = $env:DIST_DIR
          $paths = @(
            "$d/kbd-detach/x64",
            "$d/qdcm-loader/win-x64",
            "ui/GoodiesControl/tools/win-x64",
            "$d/ui-x64"
          )
          foreach ($p in $paths) { New-Item -ItemType Directory -Path $p -Force | Out-Null }

      - name: Build kbd-detach (x64)
        shell: cmd
        run: |
          call "%VSPATH%\VC\Auxiliary\Build\vcvarsall.bat" amd64
          cd kbd-detach
          nmake /f makefile clean
          nmake /f makefile
          if not exist ..\%DIST_DIR%\kbd-detach\x64 mkdir ..\%DIST_DIR%\kbd-detach\x64
          copy kbd-detach.exe ..\%DIST_DIR%\kbd-detach\x64\
          copy KeyboardService.dll ..\%DIST_DIR%\kbd-detach\x64\

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish qdcm-loader (x64 AOT)
        shell: pwsh
        working-directory: qdcm-loader
        run: |
          dotnet publish QdcmLoader.csproj -c Release -r win-x64 -p:PublishAot=true -p:SelfContained=true -p:PublishSingleFile=false -o "..\$env:DIST_DIR\qdcm-loader\win-x64"

      - name: Stage tools into UI project
        shell: pwsh
        run: |
          Copy-Item "$env:DIST_DIR/kbd-detach/x64/*" "ui/GoodiesControl/tools/win-x64" -Recurse -Force
          Copy-Item "$env:DIST_DIR/qdcm-loader/win-x64/*" "ui/GoodiesControl/tools/win-x64" -Recurse -Force

      - name: Publish UI (arm64 single-file)
        shell: pwsh
        working-directory: ui/GoodiesControl
        run: |
          dotnet publish GoodiesControl.csproj -c Release -r win-x64 -p:PublishSingleFile=true -p:SelfContained=true -o "..\..\$env:DIST_DIR\ui-x64"

      - name: Package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: goodies-binaries
          path: dist/ui-x64/MatebookGoodies.exe
